<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generation Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #22c55e;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #16a34a;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #22c55e;
        }
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }
        .test-data {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
        .concurrent-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .logs {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéØ Certificate Generation System Test</h1>
        <p>Test JavaScript-based certificate generation with simple placeholder replacement and concurrent downloads.</p>
        
        <div class="status" id="status"></div>
        
        <h2>üìã Features Being Tested</h2>
        <ul>
            <li>‚úÖ Simple placeholder replacement: <code>{{ participant_name }}</code>, <code>{{ department_name }}</code>, <code>{{ team_name }}</code></li>
            <li>‚úÖ JavaScript PDF generation without OS dependencies</li>
            <li>‚úÖ Concurrent download handling with threading</li>
            <li>‚úÖ Temporary file naming: <code>studentName[0]_eventName[0]_timestamp</code></li>
            <li>‚úÖ Real-time status tracking</li>
        </ul>
        
        <h2>üß™ Test Data</h2>
        <div class="test-data">
            <h3>Individual Event Test:</h3>
            <strong>Participant:</strong> John Doe Smith<br>
            <strong>Department:</strong> Computer Science & Engineering<br>
            <strong>Event:</strong> Python Workshop 2025<br>
            <strong>Expected File:</strong> J_P_[timestamp].pdf
        </div>
        
        <div class="test-data">
            <h3>Team Event Test:</h3>
            <strong>Participant:</strong> Alice Johnson<br>
            <strong>Department:</strong> Information Technology<br>
            <strong>Team:</strong> Code Warriors<br>
            <strong>Event:</strong> Hackathon 2025<br>
            <strong>Expected File:</strong> A_H_[timestamp].pdf
        </div>
        
        <h2>üéÆ Single Certificate Tests</h2>
        <button class="button" onclick="testIndividualCertificate()">Generate Individual Certificate</button>
        <button class="button" onclick="testTeamCertificate()">Generate Team Certificate</button>
        <button class="button" onclick="testLibraryCheck()">Check PDF Libraries</button>
        
        <h2>üî• Concurrent Download Test</h2>
        <p>Simulate 10-20 students downloading certificates simultaneously:</p>
        <div class="concurrent-test">
            <button class="button" onclick="testConcurrent(5)">5 Concurrent Downloads</button>
            <button class="button" onclick="testConcurrent(10)">10 Concurrent Downloads</button>
            <button class="button" onclick="testConcurrent(15)">15 Concurrent Downloads</button>
            <button class="button" onclick="testConcurrent(20)">20 Concurrent Downloads</button>
        </div>
        
        <h2>üìä Debug Functions</h2>
        <button class="button" onclick="checkActiveGenerations()">Check Active Generations</button>
        <button class="button" onclick="forceCleanup()">Force Cleanup</button>
        <button class="button" onclick="clearLogs()">Clear Logs</button>
        
        <h2>üìù Logs</h2>
        <div class="logs" id="logs">Test logs will appear here...</div>
    </div>
    
    <!-- Include the certificate generator -->
    <script src="/static/js/certificate_generate.js"></script>
    
    <script>
        // Override console.log to show in our logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addLog(message, type = 'log') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            logs.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog(...args);
            addLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError(...args);
            addLog(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn(...args);
            addLog(args.join(' '), 'warn');
        };
        
        // Test data
        const testData = {
            individual: {
                event_id: "individual_test_123",
                event_name: "Python Workshop 2025",
                event_date: "June 12, 2025",
                participant_name: "John Doe Smith",
                department_name: "Computer Science & Engineering",
                template_type: "individual"
            },
            team: {
                event_id: "team_test_456",
                event_name: "Hackathon 2025",
                event_date: "June 15, 2025",
                participant_name: "Alice Johnson",
                department_name: "Information Technology",
                team_name: "Code Warriors",
                template_type: "team"
            }
        };
        
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        function testLibraryCheck() {
            console.log('üîç Checking PDF libraries...');
            
            const jsPDFReady = typeof window.jsPDF !== 'undefined';
            const html2canvasReady = typeof window.html2canvas !== 'undefined';
            
            console.log(`jsPDF available: ${jsPDFReady}`);
            console.log(`html2canvas available: ${html2canvasReady}`);
            
            if (jsPDFReady && html2canvasReady) {
                showStatus('‚úÖ All PDF libraries loaded successfully!', 'success');
            } else {
                showStatus('‚ùå Some PDF libraries are missing. Check network connection.', 'error');
            }
        }
        
        async function testIndividualCertificate() {
            console.log('üéØ Testing individual certificate generation...');
            
            try {
                // Mock the certificate generator if not available
                if (!window.certificateGenerator) {
                    console.log('Creating mock certificate generator...');
                    window.certificateGenerator = {
                        generateCertificate: mockGenerateCertificate
                    };
                }
                
                await window.certificateGenerator.generateCertificate('individual_test_123');
                showStatus('‚úÖ Individual certificate test completed!', 'success');
            } catch (error) {
                console.error('Individual certificate test failed:', error);
                showStatus(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function testTeamCertificate() {
            console.log('üéØ Testing team certificate generation...');
            
            try {
                if (!window.certificateGenerator) {
                    window.certificateGenerator = {
                        generateCertificate: mockGenerateCertificate
                    };
                }
                
                await window.certificateGenerator.generateCertificate('team_test_456');
                showStatus('‚úÖ Team certificate test completed!', 'success');
            } catch (error) {
                console.error('Team certificate test failed:', error);
                showStatus(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function testConcurrent(count) {
            console.log(`üî• Starting ${count} concurrent certificate generations...`);
            
            const startTime = Date.now();
            const promises = [];
            
            // Disable all buttons during test
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(btn => btn.disabled = true);
            
            try {
                for (let i = 0; i < count; i++) {
                    const eventType = i % 2 === 0 ? 'individual' : 'team';
                    const eventId = `${eventType}_concurrent_${i}`;
                    
                    if (!window.certificateGenerator) {
                        window.certificateGenerator = {
                            generateCertificate: mockGenerateCertificate
                        };
                    }
                    
                    const promise = window.certificateGenerator.generateCertificate(eventId, `student_${i}`);
                    promises.push(promise);
                    
                    // Small delay to simulate real-world timing
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Wait for all to complete
                await Promise.all(promises);
                
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                console.log(`‚úÖ ${count} concurrent generations completed in ${duration.toFixed(2)}s`);
                console.log(`üìä Average time per certificate: ${(duration / count).toFixed(2)}s`);
                
                showStatus(`‚úÖ ${count} concurrent downloads completed in ${duration.toFixed(2)}s!`, 'success');
                
            } catch (error) {
                console.error('Concurrent test failed:', error);
                showStatus(`‚ùå Concurrent test failed: ${error.message}`, 'error');
            } finally {
                // Re-enable buttons
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        function checkActiveGenerations() {
            if (window.debugCertificateGenerator) {
                const active = window.debugCertificateGenerator.getActiveGenerations();
                console.log('Active generations:', active);
                showStatus(`Active generations: ${active.length}`, 'success');
            } else {
                showStatus('Debug functions not available', 'error');
            }
        }
        
        function forceCleanup() {
            if (window.debugCertificateGenerator) {
                window.debugCertificateGenerator.forceCleanup();
                showStatus('‚úÖ Force cleanup completed', 'success');
            } else {
                showStatus('Debug functions not available', 'error');
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs cleared...\n';
        }
        
        // Mock certificate generation for testing
        async function mockGenerateCertificate(eventId, enrollmentNo) {
            const generationId = `${eventId}_${enrollmentNo || 'current'}_${Date.now()}`;
            console.log(`üéØ Mock generation started [ID: ${generationId}]`);
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
            
            // Simulate data processing
            const isTeam = eventId.includes('team');
            const data = isTeam ? testData.team : testData.individual;
            
            console.log(`üìÑ Processing ${isTeam ? 'team' : 'individual'} certificate...`);
            
            // Simulate file creation
            const participantInitial = (data.participant_name || 'P')[0].toUpperCase();
            const eventInitial = (data.event_name || 'E')[0].toUpperCase();
            const timestamp = Date.now();
            const fileName = `${participantInitial}_${eventInitial}_${timestamp}.pdf`;
            
            console.log(`üìÅ Created temp file: ${fileName}`);
            console.log(`‚úÖ Mock generation completed [ID: ${generationId}]`);
            
            return fileName;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Certificate generation test page loaded');
            testLibraryCheck();
        });
    </script>
</body>
</html>
