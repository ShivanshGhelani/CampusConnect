{% extends "base.html" %}

{% block navigation %}
{% include 'components/client_navigation.html' %}
{% endblock %}

{% block title %}Download Certificate - {{ event.event_name }}{% endblock %}

{% block head %}
<!-- Simple Certificate Styling -->
<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 1s linear infinite;
    }
    
    .download-btn {
        background: #2563eb;
        transition: background-color 0.2s;
    }
    
    .download-btn:hover {
        background: #1d4ed8;
    }
    
    .download-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Simple Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Certificate Download</h1>
            <p class="text-lg text-gray-600">{{ event.event_name }}</p>
        </div>

        {% if error %}
        <!-- Simple Error State -->
        <div class="bg-white border border-red-200 rounded-lg p-6 mb-6 shadow-sm">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L9 10.414l1.293-1.293a1 1 0 001.414 1.414L11.414 12l1.293 1.293a1 1 0 01-1.414 1.414L10 13.414l-1.293 1.293a1 1 0 01-1.414-1.414L8.707 12 7.414 10.707a1 1 0 011.414-1.414L10 10.586l1.293-1.293z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-red-800">Certificate Not Available</h3>
                    <p class="text-red-700 mt-1">{{ error }}</p>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <a href="/client/events" class="inline-flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Events
                </a>
                <a href="/client/dashboard" class="inline-flex items-center px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                    </svg>
                    Dashboard
                </a>
            </div>
        </div>
        {% else %}
        <!-- Simple Certificate Preview -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-8">
            <div class="border-b border-gray-200 px-6 py-4">
                <h2 class="text-xl font-semibold text-gray-900">Certificate Preview</h2>
                <p class="text-gray-600">Review your certificate before downloading</p>
            </div>
            
            <div class="p-6">
                <!-- Certificate Preview Container -->
                <div id="certificate-preview" class="border border-gray-200 rounded-lg mb-6 bg-white">
                    <div id="certificate-content" class="min-h-96 flex items-center justify-center text-gray-500">
                        <div class="text-center p-8">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                            <p class="text-lg font-medium">Loading certificate template...</p>
                        </div>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="text-center">
                    <button id="download-certificate-btn" 
                            class="download-btn text-white px-8 py-3 rounded-lg text-lg font-medium inline-flex items-center gap-2 shadow-sm hover:shadow-md transition-all duration-200" 
                            onclick="downloadCertificate()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Download Certificate
                    </button>
                    
                    <div id="status-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
                </div>
            </div>
        </div>

        <!-- Simple Instructions -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Instructions</h3>
                <ul class="space-y-2 text-gray-700">
                    <li class="flex items-start">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                        Click the download button to generate your PDF certificate
                    </li>
                    <li class="flex items-start">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                        The file will be saved to your Downloads folder
                    </li>
                    <li class="flex items-start">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                        You can print or share the certificate as needed
                    </li>
                </ul>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Certificate Info</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Format:</span>
                        <span class="font-medium">PDF</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Quality:</span>
                        <span class="font-medium">High Resolution</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Size:</span>
                        <span class="font-medium">A4 Landscape</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simple Navigation -->
        <div class="text-center">
            <div class="inline-flex gap-4">
                <a href="/client/events" class="inline-flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Events
                </a>
                <a href="/client/dashboard" class="inline-flex items-center px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                    </svg>
                    Dashboard
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if not error %}
<!-- Certificate Generation JavaScript -->
<script>
// Global variables for certificate data (define first!)
const certificateData = {
    eventId: '{{ event.event_id }}',
    eventName: '{{ event.event_name }}',
    participantName: '{{ student.full_name or "Student Name" }}',
    department: '{{ student.department or "Department" }}',
    {% if team_info and team_info.team_name %}
    teamName: '{{ team_info.team_name }}',
    {% endif %}
    eventDate: '{{ event.start_datetime.strftime("%B %d, %Y") if event.start_datetime else "Event Date" }}',
    certificateId: '{{ certificate.certificate_id if certificate else "CERT-ID" }}',
    enrollmentNo: '{{ student.enrollment_no }}'
};

// Wait for page to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéì Certificate download page loaded');
    console.log('üìä Certificate Data:', certificateData);
    
    // Load certificate template first
    loadCertificateTemplate();
    
    // Check if libraries are ready
    if (typeof window.checkCertificateLibraries === 'function') {
        const isReady = window.checkCertificateLibraries();
        if (!isReady) {
            showStatus('Certificate system is loading... Please wait.', 'info');
            
            // Listen for library ready event
            window.addEventListener('certificateLibrariesReady', function(event) {
                if (event.detail.ready) {
                    showStatus('Certificate system ready!', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    showStatus('Some certificate libraries failed to load. Download may not work properly.', 'error');
                }
            });
        }
    }
});

// Load certificate template from the event's template path
async function loadCertificateTemplate() {
    try {
        showStatus('Loading certificate template...', 'info');
        
        // Check if template path is configured
        const templatePath = '{{ event.certificate_template }}';
        if (!templatePath || templatePath === 'None') {
            throw new Error('No certificate template configured for this event');
        }
        
        console.log(`üìÑ Loading template from: ${templatePath}`);
        
        // Load template content from API
        const response = await fetch(`/client/api/certificate-template/${certificateData.eventId}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to load template: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.message || 'Failed to load certificate template');
        }
        
        console.log('‚úÖ Template data received:', data);
        
        // Process template with student data
        const processedTemplate = processTemplateContent(data.template_content, data.placeholder_data);
        
        // Load the processed template into the preview
        document.getElementById('certificate-content').innerHTML = processedTemplate;
        
        hideStatus();
        console.log('‚úÖ Certificate template loaded and processed successfully');
        
    } catch (error) {
        console.error('‚ùå Failed to load certificate template:', error);
        document.getElementById('certificate-content').innerHTML = `
            <div class="text-center text-red-600 p-8">
                <svg class="w-12 h-12 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <h3 class="text-lg font-semibold mb-2">Template Loading Error</h3>
                <p class="text-sm">${error.message}</p>
                <p class="text-xs text-gray-500 mt-2">Template Path: {{ event.certificate_template }}</p>
            </div>
        `;
        showStatus(`Template error: ${error.message}`, 'error');
    }
}

// Process template content by replacing placeholders with actual data
function processTemplateContent(templateHtml, placeholderData) {
    let processedHtml = templateHtml;
    
    // Replace participant name placeholder
    processedHtml = processedHtml.replace(/\{\{participant_name\}\}/g, placeholderData.participant_name || certificateData.participantName);
    
    // Replace department name placeholder  
    processedHtml = processedHtml.replace(/\{\{department_name\}\}/g, placeholderData.department_name || certificateData.department);
    
    // Replace team name placeholder (for team-based events)
    if (placeholderData.team_name || certificateData.teamName) {
        processedHtml = processedHtml.replace(/\{\{team_name\}\}/g, placeholderData.team_name || certificateData.teamName);
    }
    
    // Also handle alternative placeholder formats with spaces
    processedHtml = processedHtml.replace(/\{\{ participant_name \}\}/g, placeholderData.participant_name || certificateData.participantName);
    processedHtml = processedHtml.replace(/\{\{ department_name \}\}/g, placeholderData.department_name || certificateData.department);
    if (placeholderData.team_name || certificateData.teamName) {
        processedHtml = processedHtml.replace(/\{\{ team_name \}\}/g, placeholderData.team_name || certificateData.teamName);
    }
    
    // Extract only the body content if this is a complete HTML document
    const bodyMatch = processedHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    if (bodyMatch) {
        // Found body content, extract it
        processedHtml = bodyMatch[1];
        console.log('‚úÖ Extracted body content from complete HTML document');
    }
    
    // Also extract any styles from the head section for inline application
    const styleMatch = templateHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
    if (styleMatch) {
        // Prepend styles to the body content
        processedHtml = `<style>${styleMatch[1]}</style>${processedHtml}`;
        console.log('‚úÖ Extracted and included styles from template');
    }
    
    return processedHtml;
}

// Show status message with simple styling
function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    
    // Remove existing status classes
    statusEl.className = 'mt-4 p-3 rounded-lg text-center font-medium';
    
    // Add appropriate classes based on type
    switch(type) {
        case 'success':
            statusEl.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
            break;
        case 'error':
            statusEl.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
            break;
        case 'info':
        default:
            statusEl.classList.add('bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
            break;
    }
    
    statusEl.classList.remove('hidden');
}

// Hide status message
function hideStatus() {
    const statusEl = document.getElementById('status-message');
    statusEl.classList.add('hidden');
}

// Update button state with simple styling
function updateButtonState(isLoading, text) {
    const btn = document.getElementById('download-certificate-btn');
    btn.disabled = isLoading;
    
    if (isLoading) {
        btn.innerHTML = `<div class="loading-spinner"></div> ${text}`;
        btn.classList.remove('download-btn');
        btn.classList.add('cursor-not-allowed', 'opacity-75');
    } else {
        btn.innerHTML = `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            ${text}
        `;
        btn.classList.add('download-btn');
        btn.classList.remove('cursor-not-allowed', 'opacity-75');
    }
}

// Main certificate download function
async function downloadCertificate() {
    console.log('üöÄ Starting certificate download...');
    
    // Debug: Log certificate data
    console.log('üìä Certificate Data:', certificateData);
    
    // Debug: Check if template content exists
    const certificateContent = document.getElementById('certificate-content');
    console.log('üìÑ Certificate content exists:', !!certificateContent);
    console.log('üìÑ Certificate content HTML length:', certificateContent ? certificateContent.innerHTML.length : 0);
    
    if (certificateContent && certificateContent.innerHTML.length > 100) {
        console.log('üìÑ First 200 chars of certificate content:', certificateContent.innerHTML.substring(0, 200));
    }
    
    updateButtonState(true, 'Generating Certificate...');
    showStatus('Preparing certificate...', 'info');
    
    try {
        // Check if libraries are available
        if (!window.html2canvas || (!window.jsPDF && !window.PDFLib)) {
            throw new Error('Certificate libraries not loaded. Please refresh the page and try again.');
        }
        
        // Create certificate element for PDF generation
        const certificateElement = await createCertificateElement();
          showStatus('Capturing certificate image...', 'info');
        
        // Debug: Log canvas dimensions and element info before capture
        console.log('üìê Canvas capture settings:', {
            element_width: certificateElement.offsetWidth,
            element_height: certificateElement.offsetHeight,
            canvas_width: Math.ceil(297 * 3.779527559),
            canvas_height: Math.ceil(210 * 3.779527559)
        });
        
        // Capture the certificate as canvas with optimized settings for certificate templates
        const canvas = await html2canvas(certificateElement, {
            scale: 2, // Higher quality
            backgroundColor: '#ffffff',
            logging: true, // Enable logging for debugging
            useCORS: true,
            allowTaint: false, // Don't allow tainted canvas
            foreignObjectRendering: false, // Disable for better compatibility
            removeContainer: true,
            width: Math.ceil(297 * 3.779527559), // A4 landscape width in pixels (297mm * 96dpi/25.4)
            height: Math.ceil(210 * 3.779527559), // A4 landscape height in pixels (210mm * 96dpi/25.4)
            windowWidth: Math.ceil(297 * 3.779527559),
            windowHeight: Math.ceil(210 * 3.779527559),
            onclone: function(clonedDoc) {
                console.log('üîç html2canvas cloned document:', clonedDoc);
                // Ensure images are visible in cloned document
                const clonedImages = clonedDoc.querySelectorAll('img');
                console.log(`üñºÔ∏è Found ${clonedImages.length} images in cloned document`);
                clonedImages.forEach((img, index) => {
                    console.log(`Image ${index + 1}: ${img.src} - Complete: ${img.complete} - Natural dimensions: ${img.naturalWidth}x${img.naturalHeight}`);
                });
            }
        });
        
        console.log('‚úÖ Canvas captured successfully:', {
            width: canvas.width,
            height: canvas.height,
            hasData: canvas.toDataURL().length > 1000
        });
        
        showStatus('Converting to PDF...', 'info');
          // Convert canvas to PDF and clean up
        await convertCanvasToPDF(canvas, certificateElement);
        
        showStatus('Certificate downloaded successfully!', 'success');
        
        // Send email notification (optional)
        try {
            await sendEmailNotification(canvas);
        } catch (emailError) {
            console.warn('Failed to send email notification:', emailError);
            // Don't fail the download if email fails
        }
        
        setTimeout(() => hideStatus(), 3000);
        
    } catch (error) {
        console.error('Certificate download failed:', error);
        showStatus(`Download failed: ${error.message}`, 'error');
    } finally {
        updateButtonState(false, 'Download Certificate (PDF)');
    }
}

// Convert image to base64 data URL for better compatibility with html2canvas
async function convertImageToBase64(img) {
    return new Promise((resolve) => {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.naturalWidth || img.width;
            canvas.height = img.naturalHeight || img.height;
            
            ctx.drawImage(img, 0, 0);
            
            const dataURL = canvas.toDataURL('image/png');
            console.log(`üîÑ Converted image to base64: ${img.src} -> ${dataURL.substring(0, 50)}...`);
            resolve(dataURL);
        } catch (error) {
            console.warn(`‚ùå Failed to convert image to base64: ${error.message}`);
            resolve(img.src); // Fallback to original src
        }
    });
}

// Create certificate element for PDF generation
async function createCertificateElement() {
    // Get the certificate content element
    const certificateContent = document.getElementById('certificate-content');
    if (!certificateContent || !certificateContent.innerHTML.trim()) {
        throw new Error('Certificate template not loaded');
    }
    
    console.log('üéØ Creating certificate element for PDF...');
    console.log('üìÑ Certificate content HTML length:', certificateContent.innerHTML.length);
    
    // Clone the entire preview container
    const previewElement = document.getElementById('certificate-preview');
    const clonedElement = previewElement.cloneNode(true);
    
    console.log('üìã Cloned element dimensions:', {
        width: previewElement.offsetWidth,
        height: previewElement.offsetHeight,
        innerHTML_length: clonedElement.innerHTML.length
    });
    
    // Apply specific styling for PDF generation
    clonedElement.style.position = 'absolute';
    clonedElement.style.left = '-9999px';
    clonedElement.style.top = '0';
    clonedElement.style.width = '297mm'; // A4 landscape width  
    clonedElement.style.height = '210mm'; // A4 landscape height
    clonedElement.style.backgroundColor = '#ffffff';
    clonedElement.style.fontFamily = 'Arial, sans-serif';
    clonedElement.style.overflow = 'hidden';
    clonedElement.style.zoom = '1';
    
    // Fix image paths to use absolute URLs
    const images = clonedElement.querySelectorAll('img');
    const imageLoadPromises = Array.from(images).map(async (img) => {
        return new Promise(async (resolve) => {
            try {
                // Convert relative paths to absolute URLs
                if (img.src.includes('../../../static/')) {
                    const newSrc = img.src.replace('../../../static/', '/static/');
                    console.log(`üñºÔ∏è Converting image path: ${img.src} -> ${newSrc}`);
                    img.src = newSrc;
                }
                  // Wait for image to load or convert to base64
                if (img.complete && img.naturalWidth > 0) {
                    console.log(`‚úÖ Image already loaded: ${img.src}`);
                    // Convert to base64 for better compatibility
                    const base64Src = await convertImageToBase64(img);
                    img.src = base64Src;
                    resolve();
                } else {
                    img.onload = async () => {
                        console.log(`‚úÖ Image loaded successfully: ${img.src}`);
                        // Convert to base64 for better compatibility
                        const base64Src = await convertImageToBase64(img);
                        img.src = base64Src;
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`‚ùå Image failed to load: ${img.src}`);
                        // Hide failed images instead of showing broken image icon
                        img.style.display = 'none';
                        resolve();
                    };
                    
                    // Set a timeout to prevent hanging
                    setTimeout(() => {
                        console.warn(`‚è∞ Image load timeout: ${img.src}`);
                        img.style.display = 'none';
                        resolve();
                    }, 5000);
                }
            } catch (error) {
                console.warn(`‚ùå Image processing error: ${error.message}`);
                img.style.display = 'none';
                resolve();
            }
        });
    });
    
    // Append to body temporarily
    document.body.appendChild(clonedElement);
    
    // Wait for all images to load
    console.log(`‚è≥ Waiting for ${images.length} images to load...`);
    await Promise.all(imageLoadPromises);
    
    // Extra time for fonts and rendering
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    console.log('‚úÖ Certificate element ready for capture');
    return clonedElement;
}

// Convert canvas to PDF and download
async function convertCanvasToPDF(canvas, certificateElement) {
    const imgData = canvas.toDataURL('image/png', 1.0);
    
    // Clean up temporary element if provided
    if (certificateElement && certificateElement.parentNode) {
        certificateElement.parentNode.removeChild(certificateElement);
    }
    
    // Try jsPDF first
    if (window.jsPDF) {
        try {
            const { jsPDF } = window.jsPDF;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            
            const fileName = `certificate_${certificateData.participantName.replace(/[^a-zA-Z0-9]/g, '_')}_${certificateData.eventName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            pdf.save(fileName);
            console.log('‚úÖ PDF downloaded successfully using jsPDF');
            return;
        } catch (jsPDFError) {
            console.warn('jsPDF failed, trying alternative method:', jsPDFError);
        }
    }
    
    // Fallback: Try PDF-lib
    if (window.PDFLib) {
        try {
            const { PDFDocument } = window.PDFLib;
            const pdfDoc = await PDFDocument.create();
            
            // Add page with canvas dimensions
            const page = pdfDoc.addPage([canvas.width, canvas.height]);
            
            // Convert canvas to PNG bytes
            const pngImageBytes = await fetch(imgData).then(res => res.arrayBuffer());
            const pngImage = await pdfDoc.embedPng(pngImageBytes);
            
            // Draw the image
            page.drawImage(pngImage, {
                x: 0,
                y: 0,
                width: canvas.width,
                height: canvas.height,
            });
            
            // Save the PDF
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            
            const fileName = `certificate_${certificateData.participantName.replace(/[^a-zA-Z0-9]/g, '_')}_${certificateData.eventName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            
            // Download the file
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            
            // Clean up
            URL.revokeObjectURL(link.href);
            console.log('‚úÖ PDF downloaded successfully using PDF-lib');
            return;
        } catch (pdfLibError) {
            console.warn('PDF-lib failed:', pdfLibError);
        }
    }
    
    // Final fallback: Just download the image
    const link = document.createElement('a');
    link.href = imgData;
    link.download = `certificate_${certificateData.participantName.replace(/[^a-zA-Z0-9]/g, '_')}_${certificateData.eventName.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
    link.click();
    
    console.warn('PDF libraries not working, downloaded as PNG instead');
}

// Send email notification (optional)
async function sendEmailNotification(canvas) {
    try {
        const imgData = canvas.toDataURL('image/png', 1.0);
        const fileName = `certificate_${certificateData.participantName.replace(/[^a-zA-Z0-9]/g, '_')}_${certificateData.eventName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
          const response = await fetch('/client/api/send-certificate-email', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                event_id: certificateData.eventId,
                enrollment_no: certificateData.enrollmentNo,
                pdf_base64: imgData.split(',')[1], // Remove data:image/png;base64, prefix
                file_name: fileName
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('Email notification sent successfully');
        } else {
            console.warn('Email notification failed:', result.message);
        }
    } catch (error) {
        console.warn('Failed to send email notification:', error);
    }
}

// Add debug function to window for testing
window.debugCertificate = function() {
    console.log('=== CERTIFICATE DEBUG ===');
    console.log('Certificate Data:', certificateData);
    
    const content = document.getElementById('certificate-content');
    console.log('Content Element:', content);
    console.log('Content HTML length:', content ? content.innerHTML.length : 0);
    if (content && content.innerHTML.length > 0) {
        console.log('First 300 chars:', content.innerHTML.substring(0, 300));
    }
    
    const preview = document.getElementById('certificate-preview');
    console.log('Preview Element:', preview);
    console.log('Preview dimensions:', preview ? {
        width: preview.offsetWidth,
        height: preview.offsetHeight,
        visible: preview.offsetParent !== null
    } : 'NOT FOUND');
    
    console.log('=== END DEBUG ===');
};

// Clean up function to remove temporary elements
function cleanupTempElements() {
    const tempElements = document.querySelectorAll('[style*="-9999px"]');
    tempElements.forEach(el => el.remove());
}

// Clean up on page unload
window.addEventListener('beforeunload', cleanupTempElements);
</script>
{% endif %}
{% endblock %}
