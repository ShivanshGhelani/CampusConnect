{% extends "base.html" %}

{% block navigation %}
{% include 'components/client_navigation.html' %}
{% endblock %}

{% block title %}Certificate Download - {{ event.event_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Navigation -->
    <nav class="mb-8">
        <a href="/client/events/{{ event.event_id }}" class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Event Details
        </a>
    </nav>

    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-700 rounded-xl shadow-2xl text-white p-8 mb-8">
        <div class="flex items-center justify-center mb-4">
            <svg class="w-16 h-16 mr-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
        </div>
        <h1 class="text-3xl font-bold mb-4 text-center">Certificate Download</h1>
        <h2 class="text-xl font-semibold mb-2 text-center">{{ event.event_name }}</h2>
        <p class="text-green-100 text-center">Your digital certificate is ready for download</p>
    </div>

    {% if error %}
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6" role="alert">
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <p class="font-medium">{{ error }}</p>
        </div>
        
        {% if not registration %}
        <div class="mt-4">
            <a href="/client/events/{{ event.event_id }}/register" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Register for Event
            </a>
        </div>
        {% elif error and "attendance" in error %}
        <div class="mt-4">
            <p class="text-sm text-red-600">Please contact the event organizers if you believe this is an error.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if validated %}
    <!-- Validation Success -->
    <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6">
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <div>
                <p class="font-medium">âœ“ All requirements verified successfully!</p>
                <p class="text-sm text-green-600">Registration, attendance, and feedback confirmed</p>
            </div>
        </div>
    </div>

    <!-- Participant Details -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
            Participant Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                <p class="text-gray-900 font-medium">{{ registration.full_name if registration else student.full_name or student.enrollment_no }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <p class="text-gray-900">{{ registration.email if registration else student.email or 'Not provided' }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Registration ID</label>
                <p class="text-gray-900 font-mono">{{ registration.registrar_id if registration else 'N/A' }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Attendance ID</label>
                <p class="text-gray-900 font-mono">{{ attendance.attendance_id if attendance else 'N/A' }}</p>
            </div>
        </div>
    </div>

    <!-- Certificate Status -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-8 mb-8">
        <div class="text-center">
            <div class="inline-block p-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full mb-4">
                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Certificate Ready</h3>
            <p class="text-gray-600 mb-6">{{ message }}</p>            <!-- Certificate Download Action -->
            <div class="space-y-4">
                {% if event.registration_mode == 'individual' and event.registration_type in ['free', 'paid'] %}
                <!-- Available for individual events (free or paid) -->
                <button id="downloadCertificateBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200">
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    <span id="downloadText">Download Certificate</span>
                </button>
                <p class="text-sm text-green-600">Click to generate and download your certificate</p>
                {% else %}
                <!-- Under development for other event types -->
                <button disabled class="bg-gray-400 text-white font-bold py-3 px-8 rounded-lg cursor-not-allowed">
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Download Certificate (Under Development)
                </button>
                <p class="text-sm text-gray-500">Certificate generation is under development for {{ event.registration_type|title }} {{ event.registration_mode|title }} events</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back to Dashboard -->
    <div class="text-center">
        <a href="/client/dashboard" 
           class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium group transition-all duration-200">
            <svg class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>
</div>

<!-- JavaScript for Certificate Download -->
{% if event.registration_mode == 'individual' and event.registration_type in ['free', 'paid'] %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById('downloadCertificateBtn');
    const downloadText = document.getElementById('downloadText');
    
    if (downloadBtn) {
        downloadBtn.addEventListener('click', async function() {
            // Disable button and show loading state
            downloadBtn.disabled = true;
            downloadBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            downloadBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            downloadText.textContent = 'Generating Certificate...';
              try {
                // Make request to download certificate
                const response = await fetch(`/client/events/{{ event.event_id }}/certificate/download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Check if response is successful
                if (response.ok) {
                    // Get the content type to determine how to handle the response
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && (contentType.includes('application/pdf') || contentType.includes('text/html'))) {
                        // Handle file download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        
                        // Get filename from response headers or create default
                        const contentDisposition = response.headers.get('content-disposition');
                        let filename = 'certificate.pdf';
                        if (contentDisposition) {
                            const filenameMatch = contentDisposition.match(/filename=(.+)/);
                            if (filenameMatch) {
                                filename = filenameMatch[1].replace(/"/g, '');
                            }
                        }
                        
                        // Create download link and trigger download
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Show success message
                        downloadText.textContent = 'Certificate Downloaded!';
                        
                        // Create a temporary success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4';
                        successDiv.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <p class="font-medium">âœ“ Certificate Downloaded Successfully!</p>
                                    <p class="text-sm text-green-600">Certificate has been downloaded to your device and emailed to you.</p>
                                    <p class="text-sm text-green-600">Check your downloads folder and email inbox.</p>
                                </div>
                            </div>
                        `;
                        
                        // Insert success message before the certificate status div
                        const certificateStatusDiv = document.querySelector('.bg-gradient-to-r.from-blue-50');
                        certificateStatusDiv.parentNode.insertBefore(successDiv, certificateStatusDiv);
                        
                    } else {
                        // Handle JSON error response
                        const result = await response.json();
                        throw new Error(result.message || 'Failed to generate certificate');
                    }
                    
                } else {
                    // Handle HTTP error
                    const result = await response.json().catch(() => ({ message: 'Server error occurred' }));
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Reset button after delay
                setTimeout(() => {
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    downloadBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    downloadText.textContent = 'Download Certificate';
                }, 3000);
                  } catch (error) {
                console.error('Error downloading certificate:', error);
                downloadText.textContent = 'Download Failed';
                
                // Create error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="font-medium">Certificate Generation Failed</p>
                            <p class="text-sm text-red-600">${error.message}</p>
                        </div>
                    </div>
                `;
                
                // Insert error message
                const certificateStatusDiv = document.querySelector('.bg-gradient-to-r.from-blue-50');
                if (certificateStatusDiv) {
                    certificateStatusDiv.parentNode.insertBefore(errorDiv, certificateStatusDiv);
                }
                
                // Reset button
                setTimeout(() => {
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    downloadBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    downloadText.textContent = 'Download Certificate';
                }, 3000);
            }
        });
    }
});
</script>
{% endif %}

{% endblock %}