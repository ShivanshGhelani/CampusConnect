{% extends "base.html" %}

{% block title %}Team Management - {{ event.event_name }}{% endblock %}

{% block head %}
<script src="/static/js/registration.js"></script>
<style>
    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        40% { transform: scale(1.05); }
        60% { transform: scale(0.95); }
        80% { transform: scale(1.01); }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-bounce-in {
        animation: bounceIn 0.6s ease forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-green-100 py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full mx-auto space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="mx-auto h-20 w-20 flex items-center justify-center rounded-full bg-gradient-to-r from-blue-600 to-green-500 shadow-lg mb-8">
                <i class="fas fa-users text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Team Management</h1>
            <p class="text-lg text-gray-600 mb-4">{{ event.event_name }}</p>
              <!-- Team Leader Info -->
            <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                <i class="fas fa-user-tie mr-2"></i>Team Leader: <strong>{{ student.full_name }}</strong> ({{ student.enrollment_no }})
            </div>
              <!-- Team Info Card - Consolidated horizontal layout -->
            {% if team_details %}
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">{{ team_details.team_name }}</h3>
                            <p class="text-gray-600">Team Registration ID: {{ team_registration_id }}</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-6">
                        <div class="text-center md:text-left">
                            <div class="text-2xl font-bold text-green-600">{{ (team_participants|length) + 1 }}</div>
                            <div class="text-sm text-gray-500">Total Members</div>
                        </div>
                        <div class="text-center md:text-left">
                            <div class="text-lg font-semibold text-blue-600">{{ event.team_size_min or 2 }} - {{ event.team_size_max or 5 }}</div>
                            <div class="text-sm text-gray-500">Size Range</div>
                        </div>
                        {% if (team_participants|length) + 1 >= (event.team_size_max or 5) %}
                        <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-exclamation-circle mr-1"></i>Max Size Reached
                        </div>
                        {% elif (team_participants|length) + 1 < (event.team_size_min or 2) %}
                        <div class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-users-slash mr-1"></i>Needs More Members
                        </div>
                        {% else %}
                        <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-check-circle mr-1"></i>Valid Size
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
              <!-- Enhanced Messages with better styling -->
            {% if success %}
            <div class="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Success!</h3>
                        <div class="text-sm text-green-700 mt-1">
                            {% if success == 'team_updated' %}
                                Team has been successfully updated. All changes have been saved.
                            {% elif success == 'participant_added' %}
                                New participant has been added to your team successfully.
                            {% elif success == 'participant_removed' %}
                                Participant has been removed from your team.
                            {% else %}
                                {{ success }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if error %}
            <div class="mb-6 bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Error</h3>
                        <div class="text-sm text-red-700 mt-1">{{ error }}</div>
                    </div>
                </div>
            </div>
            {% endif %}        </div>

        <!-- Main Content Area - Full Width Team Members -->
        <div class="bg-white rounded-xl shadow-xl border border-gray-100 p-8">            <div class="flex items-center justify-between mb-6">                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-users text-blue-600 mr-3"></i>Current Team Members
                </h2>
                {% set is_max_reached = (team_participants|length) + 1 >= (event.team_size_max or 5) %}
                <button type="button" id="addParticipantBtn" 
                        class="{% if is_max_reached %}bg-gray-400 cursor-not-allowed{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center"
                        {% if is_max_reached %}disabled{% endif %}>
                    <i class="fas fa-user-plus mr-2"></i>{% if is_max_reached %}Add Member (Max Reached){% else %}Add Member{% endif %}
                </button>
            </div>
            
            <!-- Team Size Summary -->
            <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">{{ (team_participants|length) + 1 }}</div>
                            <div class="text-sm text-gray-600">Current Members</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-gray-700">{{ event.team_size_min or 2 }} - {{ event.team_size_max or 5 }}</div>
                            <div class="text-sm text-gray-600">Team Size Range</div>
                        </div>
                    </div>
                    <div class="text-right">
                        {% set current_size = (team_participants|length) + 1 %}
                        {% set min_size = event.team_size_min or 2 %}
                        {% set max_size = event.team_size_max or 5 %}
                        {% if current_size >= max_size %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                <i class="fas fa-exclamation-circle mr-1"></i>Max Size Reached
                            </span>
                        {% elif current_size >= min_size %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check-circle mr-1"></i>Valid Size
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-info-circle mr-1"></i>Needs More Members
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Team Leader Card -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">{{ student.full_name }}</h3>
                            <p class="text-sm text-gray-600">{{ student.enrollment_no }} | {{ student.department }} | Semester {{ student.semester }}</p>
                            <p class="text-sm text-gray-600">{{ student.email }} | {{ student.mobile_no or 'N/A' }}</p>
                        </div>
                    </div>
                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-4 py-2 rounded-full">
                        <i class="fas fa-crown mr-1"></i>Team Leader
                    </span>
                </div>
            </div>
            
            <!-- Team Participants -->
            {% if team_participants %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for participant in team_participants %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center text-white font-bold text-lg mr-3">
                                {{ participant.full_name[0].upper() if participant.full_name else participant.enrollment_no[0] }}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ participant.full_name or 'Name not available' }}</h3>
                                <p class="text-sm text-gray-600">{{ participant.enrollment_no }}</p>
                                {% if participant.department %}<p class="text-xs text-gray-500">{{ participant.department }}</p>{% endif %}
                                {% if participant.semester %}<p class="text-xs text-gray-500">Semester {{ participant.semester }}</p>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button type="button" class="edit-participant-btn bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition-colors flex-1"
                                data-enrollment="{{ participant.enrollment_no }}"
                                data-name="{{ participant.full_name or '' }}"
                                data-email="{{ participant.email or '' }}"
                                data-mobile="{{ participant.mobile_no or '' }}">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button type="button" class="remove-participant-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors flex-1"
                                data-enrollment="{{ participant.enrollment_no }}"
                                data-name="{{ participant.full_name or participant.enrollment_no }}">
                            <i class="fas fa-trash mr-1"></i>Remove
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-user-plus text-6xl text-gray-300 mb-4"></i>
                <p class="text-xl text-gray-500 mb-2">No team participants added yet</p>
                <p class="text-gray-400">Click "Add Member" to invite participants to your team</p>
            </div>
            {% endif %}
        </div>

        <!-- Navigation -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/client/events/{{ event.event_id }}" 
               class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors text-center flex items-center justify-center">
                <i class="fas fa-arrow-left mr-2"></i>Back to Event Details
            </a>
            <a href="/client/dashboard" 
               class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-center flex items-center justify-center">
                <i class="fas fa-tachometer-alt mr-2"></i>Go to Dashboard
            </a>        </div>
    </div>
</div>

<!-- Add New Participant Modal -->
<div id="addParticipantModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add New Team Member</h3>
                <button type="button" id="closeAddModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="searchParticipantForm" class="space-y-4">
                <div>
                    <label for="participant_enrollment" class="block text-sm font-medium text-gray-700 mb-1">
                        Student Enrollment Number
                    </label>
                    <input type="text" name="participant_enrollment" id="participant_enrollment"
                           placeholder="e.g., 21BECE40015" maxlength="12" 
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           required>
                    <div id="enrollment-error" class="hidden text-red-600 text-sm mt-1"></div>
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>Enter the enrollment number of the student you want to add to your team
                    </div>
                </div>
                
                <!-- Team size warning -->
                {% set current_size = (team_participants|length) + 1 %}
                {% set max_size = event.team_size_max or 5 %}
                {% if current_size >= max_size %}
                <div class="bg-red-50 border-l-4 border-red-400 p-3">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-red-700 text-sm">Maximum team size of {{ max_size }} has been reached.</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-blue-700 text-sm">Current team size: {{ current_size }}/{{ max_size }}. You can add {{ max_size - current_size }} more member(s).</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelAddModal" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="searchParticipantBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                            {% if current_size >= max_size %}disabled class="bg-gray-400 cursor-not-allowed"{% endif %}>
                        <i class="fas fa-search mr-1"></i>Search & Validate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Participant Modal -->
<div id="removeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Remove Team Member</h3>
            <p class="text-sm text-gray-500 mb-4">
                Are you sure you want to remove <span id="remove-participant-name" class="font-semibold"></span> from your team?
            </p>
            <form id="removeParticipantForm" action="/client/events/{{ event.event_id }}/manage-team" method="POST">
                <input type="hidden" name="action" value="remove_participant">
                <input type="hidden" name="participant_enrollment" id="remove-participant-enrollment">
                  <div class="flex flex-col">
                    <!-- Min team size warning -->
                    {% if (team_participants|length) + 1 <= (event.team_size_min or 2) %}
                    <div class="mb-3 text-sm text-yellow-600 bg-yellow-50 p-2 rounded">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Cannot remove - minimum team size is {{ event.team_size_min or 2 }}
                    </div>
                    {% endif %}
                    
                    <div class="flex justify-center space-x-4">
                        <button type="button" id="cancelRemove" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors"
                                {% if (team_participants|length) + 1 <= (event.team_size_min or 2) %}disabled="disabled" class="bg-gray-400 cursor-not-allowed"{% endif %}>
                            Remove
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Participant Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Confirm Adding Participant</h3>
                <button type="button" id="cancelConfirm" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="studentDetails" class="mb-6 bg-gray-50 p-4 rounded-lg">
                <!-- Student details will be displayed here -->
                <div class="flex justify-center items-center py-6 px-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading student information...
                </div>
            </div>
            
            <form id="addParticipantForm" action="/client/events/{{ event.event_id }}/manage-team" method="POST" class="space-y-4">
                <input type="hidden" name="action" value="add_participant">
                <input type="hidden" name="participant_enrollment" id="confirm-participant-enrollment">
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelConfirmBtn" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="confirmAddBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-1"></i>Confirm & Add
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Participant Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Edit Participant Details</h3>
                <button type="button" id="cancelEdit" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editParticipantForm" action="/client/events/{{ event.event_id }}/manage-team" method="POST" class="space-y-4">
                <input type="hidden" name="action" value="update_participant">
                <input type="hidden" name="participant_enrollment" id="edit-participant-enrollment">
                
                <div>
                    <label for="edit_participant_name" class="block text-sm font-medium text-gray-700 mb-1">
                        Full Name
                    </label>
                    <input type="text" name="participant_name" id="edit_participant_name"
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="edit_participant_email" class="block text-sm font-medium text-gray-700 mb-1">
                        Email
                    </label>
                    <input type="email" name="participant_email" id="edit_participant_email"
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="edit_participant_mobile" class="block text-sm font-medium text-gray-700 mb-1">
                        Mobile Number
                    </label>
                    <input type="tel" name="participant_mobile" id="edit_participant_mobile"
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelEditBtn" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-1"></i>Update
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Team Management'); // Debug log
    
    // Get modal elements
    const addParticipantModal = document.getElementById('addParticipantModal');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const closeAddModal = document.getElementById('closeAddModal');
    const cancelAddModal = document.getElementById('cancelAddModal');
    const confirmModal = document.getElementById('confirmModal');
    const removeModal = document.getElementById('removeModal');
    const editModal = document.getElementById('editModal');
    
    // Debug: Check if elements exist
    console.log('Elements found:');
    console.log('- Add Participant Modal:', !!addParticipantModal);
    console.log('- Add Participant Button:', !!addParticipantBtn);
    console.log('- Close Add Modal Button:', !!closeAddModal);
    console.log('- Cancel Add Modal Button:', !!cancelAddModal);
      // Add Participant Modal functionality
    if (addParticipantBtn) {
        console.log('Adding click event listener to Add Member button');
        addParticipantBtn.addEventListener('click', function(e) {
            console.log('Add Member button clicked!'); // Debug log
            e.preventDefault(); // Prevent any default behavior
            
            // Check if button is disabled
            if (this.disabled) {
                console.log('Button is disabled, not opening modal');
                return;
            }
            
            if (addParticipantModal) {
                console.log('Opening add participant modal');
                addParticipantModal.classList.remove('hidden');
                setTimeout(() => {
                    const modalContent = addParticipantModal.querySelector('.relative');
                    if (modalContent) {
                        modalContent.classList.add('animate-bounce-in');
                    }
                }, 10);
            } else {
                console.error('Add participant modal not found');
            }
        });
    } else {
        console.error('Add participant button not found');
    }
    
    [closeAddModal, cancelAddModal].forEach(button => {
        button.addEventListener('click', function() {
            addParticipantModal.classList.add('hidden');
            // Clear form when closing
            document.getElementById('searchParticipantForm').reset();
            document.getElementById('enrollment-error').classList.add('hidden');
        });
    });
    
    // Remove participant functionality
    const removeButtons = document.querySelectorAll('.remove-participant-btn');
    const removeModal = document.getElementById('removeModal');
    const removeForm = document.getElementById('removeParticipantForm');
    const cancelRemove = document.getElementById('cancelRemove');
    
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const enrollment = this.getAttribute('data-enrollment');
            const name = this.getAttribute('data-name');
            
            document.getElementById('remove-participant-name').textContent = name;
            document.getElementById('remove-participant-enrollment').value = enrollment;
            
            removeModal.classList.remove('hidden');
        });
    });
    
    cancelRemove.addEventListener('click', function() {
        removeModal.classList.add('hidden');
    });
    
    // Edit participant functionality
    const editButtons = document.querySelectorAll('.edit-participant-btn');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editParticipantForm');
    const cancelEdit = document.getElementById('cancelEdit');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const enrollment = this.getAttribute('data-enrollment');
            const name = this.getAttribute('data-name');
            const email = this.getAttribute('data-email');
            const mobile = this.getAttribute('data-mobile');
            
            document.getElementById('edit-participant-enrollment').value = enrollment;
            document.getElementById('edit_participant_name').value = name;
            document.getElementById('edit_participant_email').value = email;
            document.getElementById('edit_participant_mobile').value = mobile;
            
            editModal.classList.remove('hidden');
        });
    });
    
    [cancelEdit, cancelEditBtn].forEach(button => {
        button.addEventListener('click', function() {
            editModal.classList.add('hidden');
        });
    });      // Close modals when clicking outside
    [removeModal, editModal, confirmModal, addParticipantModal].forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                // Clear add participant form when closing
                if (modal === addParticipantModal) {
                    document.getElementById('searchParticipantForm').reset();
                    document.getElementById('enrollment-error').classList.add('hidden');
                }
            }
        });
    });
      // Add participant form validation
    const addForm = document.getElementById('addParticipantForm');
    const enrollmentInput = document.getElementById('participant_enrollment');
    
    // Format enrollment input
    enrollmentInput.addEventListener('input', function() {
        let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        this.value = value;
    });
    
    // Validate enrollment format on blur
    enrollmentInput.addEventListener('blur', function() {
        const enrollment = this.value.trim();
        const errorDiv = document.getElementById('enrollment-error');
        
        if (enrollment) {
            const enrollmentPattern = /^\d{2}[A-Z]{2,4}\d{5}$/;
            if (!enrollmentPattern.test(enrollment)) {
                errorDiv.textContent = 'Invalid enrollment number format (e.g., 21BECE40015)';
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
        }
    });// Add participant search and confirmation flow
    const searchForm = document.getElementById('searchParticipantForm');
    const confirmModal = document.getElementById('confirmModal');
    const studentDetailsDiv = document.getElementById('studentDetails');
    const addForm = document.getElementById('addParticipantForm');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
    
    // Search form submission
    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const enrollment = enrollmentInput.value.trim();
        const enrollmentPattern = /^\d{2}[A-Z]{2,4}\d{5}$/;
        const currentTeamSize = {{ (team_participants|length) + 1 }};
        const maxTeamSize = {{ event.team_size_max or 5 }};
        const errorDiv = document.getElementById('enrollment-error');
        
        // Clear previous errors
        errorDiv.textContent = '';
        errorDiv.classList.add('hidden');
        
        // Basic validation
        if (!enrollment || !enrollmentPattern.test(enrollment)) {
            errorDiv.textContent = 'Please enter a valid enrollment number (e.g., 21BECE40015)';
            errorDiv.classList.remove('hidden');
            enrollmentInput.focus();
            return false;
        }
        
        if (currentTeamSize >= maxTeamSize) {
            errorDiv.textContent = `Maximum team size of ${maxTeamSize} reached`;
            errorDiv.classList.remove('hidden');
            return false;
        }
          // Show loading state in student details div
        studentDetailsDiv.innerHTML = `
            <div class="flex justify-center items-center py-6 px-4 text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading student information...
            </div>
        `;
          
        // Close add participant modal and open confirmation modal with animation
        addParticipantModal.classList.add('hidden');
        confirmModal.classList.remove('hidden');
        setTimeout(() => {
            const modalContent = confirmModal.querySelector('.relative');
            modalContent.classList.add('animate-bounce-in');
        }, 10);
        
        // Fetch student details
        try {
            const eventId = '{{ event.event_id }}';
            const teamId = '{{ team_registration_id }}';
            const response = await fetch(`/client/api/validate-participant?enrollment=${encodeURIComponent(enrollment)}&event_id=${eventId}&team_id=${teamId}`);
            const data = await response.json();
            
            // Process response
            if (data.success && data.can_add) {
                // Populate student details for confirmation
                const student = data.student;
                document.getElementById('confirm-participant-enrollment').value = student.enrollment_no;
                
                // Create student profile card
                studentDetailsDiv.innerHTML = `
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                        <div class="p-4 border-b border-gray-200 flex items-center">
                            <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                ${student.full_name ? student.full_name[0].toUpperCase() : 'S'}
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${student.full_name}</h3>
                                <p class="text-gray-600">${student.enrollment_no}</p>
                            </div>
                        </div>
                        <div class="p-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Department:</span>
                                <span class="font-semibold">${student.department || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Semester:</span>
                                <span class="font-semibold">${student.semester || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Email:</span>
                                <span class="font-semibold">${student.email || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Mobile:</span>
                                <span class="font-semibold">${student.mobile_no || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Gender:</span>
                                <span class="font-semibold">${student.gender || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-3 text-green-700 text-sm text-center border-t border-green-100">
                            <i class="fas fa-check-circle mr-1"></i>Student validated successfully. Please confirm to add to your team.
                        </div>
                    </div>
                `;
                
                // Enable the confirm button
                document.getElementById('confirmAddBtn').disabled = false;
            } else {
                // Show error
                studentDetailsDiv.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-red-700">${data.message || 'Unable to validate student'}</p>
                            </div>
                        </div>
                    </div>
                `;                    // Disable the confirm button
                document.getElementById('confirmAddBtn').disabled = true;
                document.getElementById('confirmAddBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('confirmAddBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
                  // Show error in the original search form as well
                const errorDiv = document.getElementById('enrollment-error');
                errorDiv.textContent = data.message || 'Student validation failed';
                errorDiv.classList.remove('hidden');
                
                // Close confirmation modal and reopen add participant modal to show error
                setTimeout(() => {
                    confirmModal.classList.add('hidden');
                    addParticipantModal.classList.remove('hidden');
                }, 2500);
            }
        } catch (error) {
            console.error('Validation error:', error);
            studentDetailsDiv.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-red-700">An error occurred while validating the student.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Disable the confirm button
            document.getElementById('confirmAddBtn').disabled = true;
            document.getElementById('confirmAddBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
            document.getElementById('confirmAddBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
              // Show error in the search form as well
            const errorDiv = document.getElementById('enrollment-error');
            errorDiv.textContent = 'An error occurred while validating the student';
            errorDiv.classList.remove('hidden');
            
            // Close confirmation modal and reopen add participant modal
            setTimeout(() => {
                confirmModal.classList.add('hidden');
                addParticipantModal.classList.remove('hidden');
            }, 2000);
        }
    });      // Close confirmation modal
    [cancelConfirm, cancelConfirmBtn].forEach(button => {
        button.addEventListener('click', function() {
            confirmModal.classList.add('hidden');
            // Reopen the add participant modal when canceling confirmation
            addParticipantModal.classList.remove('hidden');
        });
    });
      // Clear enrollment input after successful confirmation
    addForm.addEventListener('submit', function() {
        // Clear the search input field for better UX after adding
        setTimeout(() => {
            document.getElementById('participant_enrollment').value = '';
            document.getElementById('searchParticipantForm').reset();
            document.getElementById('enrollment-error').classList.add('hidden');
        }, 500);
    });
      // Handle the confirmation form submission
    addForm.addEventListener('submit', function(e) {
        const enrollment = document.getElementById('confirm-participant-enrollment').value.trim();
        const currentTeamSize = {{ (team_participants|length) + 1 }};
        const maxTeamSize = {{ event.team_size_max or 5 }};
        
        if (!enrollment) {
            e.preventDefault();
            showAlert('Participant enrollment number is missing', 'error');
            return false;
        }
        
        if (currentTeamSize >= maxTeamSize) {
            e.preventDefault();
            showAlert(`Maximum team size of ${maxTeamSize} reached`, 'error');
            return false;
        }
        
        // Show loading state
        const confirmBtn = document.getElementById('confirmAddBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
        confirmBtn.classList.add('bg-green-500');
        
        // Show a message that the form is being submitted
        showAlert('Adding participant to team...', 'info');
        
        // Allow form submission to proceed
        return true;
    });
      // Alert function
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        
        // Set styling based on alert type
        let styling, icon;
        switch(type) {
            case 'error':
                styling = 'bg-red-100 border-red-400 text-red-700';
                icon = 'exclamation-triangle';
                break;
            case 'info':
                styling = 'bg-blue-100 border-blue-400 text-blue-700';
                icon = 'info-circle';
                break;
            case 'warning':
                styling = 'bg-yellow-100 border-yellow-400 text-yellow-700';
                icon = 'exclamation-circle';
                break;
            case 'success':
            default:
                styling = 'bg-green-100 border-green-400 text-green-700';
                icon = 'check-circle';
                break;
        }
        
        alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${styling}`;
        alertDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${icon} mr-2"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Remove the alert after a timeout
        setTimeout(() => {
            alertDiv.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => alertDiv.remove(), 500);
        }, 4000);
    }
});
</script>

{% endblock %}
